[[extend 'layout.html']]

[[block header]]
[[icon='fa fa-list-check']]
[[breadcamp='Task Details']]
[[end]]
[[block content]]
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h5 class="mb-1">[[=task.task]]</h5>
    <div class="text-muted small">Project: [[=task.project_id and db.project(task.project_id).name or '']] &nbsp;·&nbsp; Module: [[=task.module_id and db.module(task.module_id).name or '']] </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="[[=URL('tasks')]]"><i class="fa fa-arrow-left me-1"></i>Back</a>
    <a class="btn btn-primary btn-sm" href="[[=URL('tasks/%s/edit' % task.id)]]"><i class="fa fa-pen me-1"></i>Edit</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <div class="badge bg-light text-dark text-uppercase">[[=task.task_status]]</div>
          <div class="badge bg-primary-subtle text-dark text-uppercase">[[=task.priority]]</div>
        </div>
        <div class="small text-muted">
          [[if task.start_date:]]Start: [[=task.start_date]] [[pass]]
          [[if task.end_date:]] · Due: [[=task.end_date]] [[pass]]
        </div>
      </div>
      <div class="card-body">
        <p class="mb-3">[[=task.description or 'No description']]</p>
        <div class="row">
          <div class="col-md-4">
            <div class="text-muted small">Owner</div>
            <div>[[=task.owner_id and db.user(task.owner_id).email or '']]</div>
          </div>
          <div class="col-md-4">
            <div class="text-muted small">Reliever</div>
            <div>[[=task.reliever_id and db.user(task.reliever_id).email or '-']]</div>
          </div>
          <div class="col-md-4">
            <div class="text-muted small">Comments</div>
            <div>[[=task.comments or '-']]</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Subtasks</h6>
        <a class="btn btn-outline-primary btn-sm" href="[[=URL('task_subtask/create', vars={'task_id':task.id})]]"><i class="fa fa-plus me-1"></i>Add</a>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Dates</th>
            </tr>
          </thead>
          <tbody>
            [[if not subtasks:]]
            <tr><td colspan="4" class="text-center text-muted py-3">No subtasks.</td></tr>
            [[else:]]
            [[for st in subtasks:]]
            <tr>
              <td>[[=st.title]]</td>
              <td><span class="badge bg-light text-dark text-uppercase">[[=st.status]]</span></td>
              <td><span class="badge bg-primary-subtle text-dark text-uppercase">[[=st.priority]]</span></td>
              <td class="text-nowrap">[[=st.start_date or '' ]] [[='→' if st.end_date else '' ]] [[=st.end_date or '' ]]</td>
            </tr>
            [[pass]]
            [[pass]]
          </tbody>
        </table>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Comments</h6>
        <a class="btn btn-outline-primary btn-sm" href="[[=URL('task_comment/create', vars={'task_id':task.id})]]"><i class="fa fa-plus me-1"></i>Add</a>
      </div>
      <div class="list-group list-group-flush">
        [[if not comments:]]
        <div class="list-group-item text-muted">No comments.</div>
        [[else:]]
        [[for c in comments:]]
        <div class="list-group-item">
          <div class="d-flex justify-content-between">
            <div class="fw-semibold">[[=db.user(c.user_id).email if c.user_id else '']] <span class="badge bg-light text-dark text-uppercase ms-2">[[=c.visibility]]</span></div>
            <small class="text-muted">[[=c.created_on]]</small>
          </div>
          <div>[[=c.body]]</div>
        </div>
        [[pass]]
        [[pass]]
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm mb-3">
      <div class="card-header">
        <h6 class="mb-0">Status</h6>
      </div>
      <div class="card-body">
        <form method="post" action="[[=URL('tasks/%s/status' % task.id)]]" class="row g-2">
          <div class="col-12">
            <label class="form-label small text-muted">Change status</label>
            <select name="status" class="form-select form-select-sm">
              [[for val, label in status_options:]]
              <option value="[[=val]]" [[ 'selected' if task.task_status==val else '' ]]>[[=label]]</option>
              [[pass]]
            </select>
          </div>
          <div class="col-12">
            <label class="form-label small text-muted">Note (optional)</label>
            <textarea name="note" class="form-control form-control-sm" rows="2"></textarea>
          </div>
          <div class="col-12">
            <button class="btn btn-primary btn-sm" type="submit"><i class="fa fa-rotate me-1"></i>Update Status</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Assignees</h6>
        <a class="btn btn-outline-primary btn-sm" href="[[=URL('task_assignee/create', vars={'task_id':task.id})]]"><i class="fa fa-plus me-1"></i>Add</a>
      </div>
      <ul class="list-group list-group-flush">
        [[if not assignees:]]
        <li class="list-group-item text-muted">No additional assignees.</li>
        [[else:]]
        [[for a in assignees:]]
        <li class="list-group-item d-flex justify-content-between">
          <div>
            <div class="fw-semibold">[[=a.user_id and db.user(a.user_id).email or '']]</div>
            <small class="text-muted text-uppercase">[[=a.role]]</small>
          </div>
        </li>
        [[pass]]
        [[pass]]
      </ul>
    </div>

    <div class="card shadow-sm">
      <div class="card-header">
        <h6 class="mb-0">Activity</h6>
      </div>
      <div class="list-group list-group-flush">
        [[if not logs:]]
        <div class="list-group-item text-muted">No status changes yet.</div>
        [[else:]]
        [[for log in logs:]]
        <div class="list-group-item">
          <div class="d-flex justify-content-between">
            <div><span class="badge bg-light text-dark text-uppercase">[[=log.from_status]]</span> → <span class="badge bg-primary-subtle text-dark text-uppercase">[[=log.to_status]]</span></div>
            <small class="text-muted">[[=log.changed_on]]</small>
          </div>
          <div class="small text-muted">[[=log.changed_by and db.user(log.changed_by).email or '' ]]</div>
          [[if log.note:]]<div class="mt-1">[[=log.note]]</div>[[pass]]
        </div>
        [[pass]]
        [[pass]]
      </div>
    </div>
  </div>
</div>
[[end]]